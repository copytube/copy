<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>등록한 영상 관리 - CopyTube</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    main { max-width:1100px; margin:96px auto 40px; padding:0 16px; text-align:left; }
    .badge { font-size:12px; color:#9ef01a; font-weight:800; margin-left:8px; }
    .toolbar { display:flex; gap:8px; align-items:center; margin:8px 0 12px; flex-wrap:wrap; }
    .list { display:flex; flex-direction:column; gap:10px; }
    .card {
      display:grid; gap:10px; grid-template-columns: 1.2fr 1fr 1fr auto;
      background:#1b1b1b; border:1px solid #333; border-radius:10px; padding:10px;
    }
    @media (max-width:900px){
      .card { grid-template-columns: 1fr; }
    }
    .title { font-weight:800; margin-bottom:4px; }
    .sub { font-size:12px; color:#9aa0a6; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .chips { display:flex; flex-direction:column; gap:4px; }
    .chip { display:inline-block; font-size:12px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:6px; padding:4px 6px; width:max-content; }
    .controls { display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    select {
      background:#0f0f0f; color:#fff; border:1px solid #2a2a2a; border-radius:6px; padding:6px 8px;
      min-width:150px;
    }
    button.btn { padding:8px 10px; border:0; border-radius:8px; cursor:pointer; font-weight:700; }
    .btn-primary{ background:#4ea1ff; color:#fff; }
    .btn-danger{ background:#dc2626; color:#fff; }
    .pager { display:flex; gap:6px; align-items:center; justify-content:center; margin-top:14px; }
    .pager button { padding:8px 10px; border-radius:8px; border:1px solid #333; background:#0f0f0f; color:#fff; cursor:pointer; }
    .empty { color:#9aa0a6; margin:16px 0; }
  </style>
</head>
<body>
<header id="topbar">
  <div class="brand">
    <a href="./"><img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/></a>
  </div>
  <div class="right">
    <a id="signupLink" class="link" href="signup.html">Sign up</a>
    <a id="signinLink" class="link" href="signin.html">Sign in</a>
    <span id="welcome" class="welcome"></span>
  </div>
</header>

<main>
  <h2 style="display:flex;align-items:center;gap:8px;">
    등록한 영상 관리
    <small id="adminBadge" class="badge" style="display:none;">관리자: 전체 표시</small>
  </h2>
  <div id="msg" class="welcome" style="margin:6px 0 10px;"></div>
  <div class="toolbar">
    <span id="countInfo" class="welcome"></span>
  </div>
  <div id="list" class="list"></div>
  <div id="pager" class="pager" style="display:none;">
    <button id="prevBtn">이전</button>
    <span id="pageLabel" class="welcome"></span>
    <button id="nextBtn">다음</button>
  </div>
</main>

<script type="module" src="js/firebase-init.js"></script>
<script type="module">
  import { auth, db } from './js/firebase-init.js';
  import { onAuthStateChanged } from './js/auth.js';
  import {
    collection, query, where, getDocs, orderBy, limit, startAfter,
    doc, getDoc, updateDoc, deleteDoc
  } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
  import { CATEGORY_GROUPS } from './js/categories.js?v=20250818';

  const $ = s => document.querySelector(s);
  const list = $('#list'), msg = $('#msg'), badge = $('#adminBadge');
  const pager = $('#pager'), pageLabel = $('#pageLabel');
  const PAGE_SIZE = 30;

  // 카테고리 옵션 (개인자료 제외)
  const FLAT = CATEGORY_GROUPS
    .filter(g => g.key !== 'personal')
    .flatMap(g => g.children.map(c => ({ value:c.value, label:c.label })));
  const LABEL = new Map(FLAT.map(o => [o.value, o.label]));

  // 상태
  let isAdmin = false;
  let mode = 'user'; // 'user' | 'admin'
  let uid = null;

  // 페이지네이션 상태 (admin: 서버 커서, user: 클라이언트 분할)
  let adminCursors = [];  // [{page:1, cursor:DocumentSnapshot|null}, ...]
  let adminPage = 1;
  let userAll = [];       // 클라이언트 전체 목록
  let userPage = 1;

  onAuthStateChanged(auth, async (user)=>{
    $('#signupLink').classList.toggle('hidden', !!user);
    $('#signinLink').classList.toggle('hidden', !!user);
    $('#welcome').textContent = user ? `안녕하세요, ${user.displayName||'회원'}님` : '';

    if(!user){ msg.textContent = '로그인 후 이용하세요.'; return; }
    uid = user.uid;

    // 관리자 여부
    try{
      const a = await getDoc(doc(db,'admins', uid));
      isAdmin = a.exists();
    }catch{ isAdmin = false; }

    mode = isAdmin ? 'admin' : 'user';
    badge.style.display = isAdmin ? '' : 'none';

    if(mode==='admin'){
      adminCursors = [{page:1, cursor:null}];
      adminPage = 1;
      await loadAdminPage(1);
    }else{
      await loadUserAll();
      userPage = 1;
      renderUserPage(1);
    }
  });

  /* =========== ADMIN: 서버 페이지네이션(작성일 내림차순) =========== */
  async function loadAdminPage(page){
    msg.textContent = '불러오는 중...';

    // 필요한 커서가 없으면 직전 페이지부터 순회해서 채움
    while(adminCursors.length < page){
      const last = adminCursors[adminCursors.length-1].cursor;
      const q = last
        ? query(collection(db,'videos'), orderBy('createdAt','desc'), startAfter(last), limit(PAGE_SIZE))
        : query(collection(db,'videos'), orderBy('createdAt','desc'), limit(PAGE_SIZE));
      const snap = await getDocs(q);
      if(snap.empty && adminCursors.length===1){
        list.innerHTML = ''; pager.style.display='none';
        msg.textContent = '영상이 없습니다.'; return;
      }
      const lastDoc = snap.docs[snap.docs.length-1] || null;
      adminCursors.push({page:adminCursors.length+1, cursor:lastDoc});
      if(adminCursors.length === page){
        renderRows(snap.docs.map(d=>({ id:d.id, ...d.data() })));
        pageLabel.textContent = `페이지 ${page}`;
        pager.style.display = snap.size===PAGE_SIZE || page>1 ? '' : 'none';
        msg.textContent = '';
        return;
      }
      if(snap.size < PAGE_SIZE) break; // 더 이상 다음 페이지 없음
    }

    // 이미 구해둔 커서가 있는 페이지 다시 읽기
    const cursor = adminCursors[page-1].cursor;
    const q = cursor
      ? query(collection(db,'videos'), orderBy('createdAt','desc'), startAfter(cursor), limit(PAGE_SIZE))
      : query(collection(db,'videos'), orderBy('createdAt','desc'), limit(PAGE_SIZE));
    const snap = await getDocs(q);
    renderRows(snap.docs.map(d=>({ id:d.id, ...d.data() })));
    pageLabel.textContent = `페이지 ${page}`;
    pager.style.display = snap.size===PAGE_SIZE || page>1 ? '' : 'none';
    msg.textContent = '';
  }

  $('#prevBtn').addEventListener('click', async ()=>{
    if(mode!=='admin') { if(userPage>1){ renderUserPage(--userPage); } return; }
    if(adminPage>1){ adminPage--; await loadAdminPage(adminPage); }
  });
  $('#nextBtn').addEventListener('click', async ()=>{
    if(mode!=='admin') { if(userPage < Math.ceil(userAll.length/PAGE_SIZE)){ renderUserPage(++userPage); } return; }
    adminPage++; await loadAdminPage(adminPage);
  });

  /* =========== USER: 인덱스 없이 전부 가져와서 클라 분할 =========== */
  async function loadUserAll(){
    msg.textContent = '불러오는 중...';
    const qMine = query(collection(db,'videos'), where('uid','==', uid));
    const snap = await getDocs(qMine);
    userAll = snap.docs.map(d=>({ id:d.id, ...d.data() }))
      .sort((a,b)=> toMs(b.createdAt) - toMs(a.createdAt));
    $('#countInfo').textContent = `내 영상 ${userAll.length}개`;
    msg.textContent = userAll.length ? '' : '영상이 없습니다.';
    pager.style.display = userAll.length > PAGE_SIZE ? '' : 'none';
  }
  function toMs(t){
    try { return t?.toMillis ? t.toMillis() : (typeof t==='number' ? t : 0); }
    catch { return 0; }
  }
  function renderUserPage(p){
    const start = (p-1)*PAGE_SIZE;
    const rows = userAll.slice(start, start+PAGE_SIZE);
    renderRows(rows);
    pageLabel.textContent = `페이지 ${p} / ${Math.max(1, Math.ceil(userAll.length/PAGE_SIZE))}`;
  }

  /* =========== 공통: 렌더 & 액션 =========== */
  function renderRows(rows){
    list.innerHTML = '';
    for(const v of rows){
      const el = document.createElement('div');
      el.className = 'card';
      el.dataset.id = v.id;

      const cats = Array.isArray(v.categories) ? v.categories : [];
      const chips = cats.map(c=>`<span class="chip">${LABEL.get(c) || c}</span>`).join('') || `<span class="sub">카테고리 없음</span>`;

      el.innerHTML = `
        <div>
          <div class="title">${escapeHTML(v.title || v.url)}</div>
          <div class="sub">${escapeHTML(v.url)}${v.uid ? ' • 업로더: '+escapeHTML(v.uid) : ''}</div>
        </div>
        <div><div class="chips">${chips}</div></div>
        <div class="controls">
          ${renderSelects(cats)}
          <button class="btn btn-primary btnApply">변경</button>
        </div>
        <div class="controls" style="justify-content:flex-end;">
          <button class="btn btn-danger btnDelete">삭제</button>
        </div>
      `;

      el.querySelector('.btnApply').addEventListener('click', ()=> applyCats(v.id, el));
      el.querySelector('.btnDelete').addEventListener('click', ()=> del(v.id));
      list.appendChild(el);
    }
  }

  function renderSelects(current){
    const opts = ['<option value="">선택안함</option>']
      .concat(FLAT.map(o=>`<option value="${o.value}">${o.label}</option>`)).join('');
    // 기본은 '선택안함' 3개. (현재 카테고리는 왼쪽 칩으로만 보여줌)
    return `
      <select class="sel1">${opts}</select>
      <select class="sel2">${opts}</select>
      <select class="sel3">${opts}</select>
    `;
  }

  function escapeHTML(s){
    return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
  }

  async function applyCats(id, card){
    const s1 = card.querySelector('.sel1').value.trim();
    const s2 = card.querySelector('.sel2').value.trim();
    const s3 = card.querySelector('.sel3').value.trim();
    const picked = [s1,s2,s3].filter(Boolean);

    // 중복 제거
    const cats = [...new Set(picked)];
    if(cats.length===0){ alert('카테고리를 선택해 주세요.'); return; }
    if(cats.length>3){ alert('최대 3개까지 선택 가능합니다.'); return; }

    try{
      await updateDoc(doc(db,'videos', id), { categories: cats });
      msg.textContent = '카테고리가 변경되었습니다.';
      // 화면 갱신: 칩만 바꿈
      const chips = cats.map(c=>`<span class="chip">${LABEL.get(c)||c}</span>`).join('');
      card.querySelector('.chips').innerHTML = chips;
      // 선택박스 초기화
      card.querySelectorAll('select').forEach(s=> s.value='');
    }catch(e){
      console.error(e);
      alert('변경 실패: '+(e.message||e));
    }
  }

  async function del(id){
    if(!confirm('정말 삭제하시겠습니까?')) return;
    try{
      await deleteDoc(doc(db,'videos', id));
      const gone = list.querySelector(`.card[data-id="${id}"]`);
      if(gone) gone.remove();
      msg.textContent = '삭제되었습니다.';
    }catch(e){
      console.error(e);
      alert('삭제 실패: '+(e.message||e));
    }
  }
</script>
</body>
</html>
