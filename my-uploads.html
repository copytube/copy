<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>업로드영상 - Copytube</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube 홈으로">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
    </div>
  </header>

  <main class="intro" style="align-items:flex-start; padding-top:96px;">
    <div style="max-width:720px;width:100%;text-align:left;">
      <h2>업로드한 영상</h2>
      <div id="msg" class="welcome" style="margin:8px 0 12px;"></div>

      <div id="list" style="display:flex;flex-direction:column;gap:8px;"></div>

      <div style="margin-top:14px;display:flex;gap:8px;">
        <button id="btnDelete" style="padding:10px 14px;border:0;border-radius:8px;background:#dc2626;color:#fff;cursor:pointer;">선택 삭제</button>
        <a href="./" class="link" style="align-self:center;">← 돌아가기</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from './js/auth.js';
    import {
      collection, query, where, orderBy, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $ = (s)=>document.querySelector(s);
    const list = $('#list');
    const msg  = $('#msg');
    let selectedId = null;

    onAuthStateChanged(auth, async (user)=>{
      $('#signupLink').classList.toggle('hidden', !!user);
      $('#signinLink').classList.toggle('hidden', !!user);
      $('#welcome').textContent = user ? `안녕하세요, ${user.displayName||'회원'}님` : '';

      if(!user){ msg.textContent = '로그인 후 이용하세요.'; list.innerHTML=''; return; }
      msg.textContent = '불러오는 중...';

      try{
        // 1차: uid + orderBy(createdAt desc) (정상은 이 경로)
        const q1 = query(
          collection(db,'videos'),
          where('uid','==',user.uid),
          orderBy('createdAt','desc')
        );
        const snap = await getDocs(q1);
        await renderList(snap.docs.map(d=>({ id:d.id, ...d.data() })));
        msg.textContent = ''; // 성공
      }catch(err){
        console.warn('복합 인덱스 필요 또는 쿼리 실패. 대안 경로로 진행:', err);

        // 2차 대안: uid=만 걸고 가져온 후 클라이언트에서 createdAt desc 정렬
        try{
          const q2 = query(
            collection(db,'videos'),
            where('uid','==',user.uid)
          );
          const snap2 = await getDocs(q2);
          const rows = snap2.docs.map(d=>({ id:d.id, ...d.data() }));

          rows.sort((a,b)=>{
            const ta = (a.createdAt && a.createdAt.toMillis) ? a.createdAt.toMillis() : 0;
            const tb = (b.createdAt && b.createdAt.toMillis) ? b.createdAt.toMillis() : 0;
            return tb - ta;
          });

          await renderList(rows);
          msg.innerHTML = '인덱스 미구성으로 임시 정렬 중입니다. 콘솔에서 복합 인덱스를 만들면 더 빨라집니다.';
        }catch(err2){
          console.error('대안 경로도 실패:', err2);
          msg.textContent = `목록을 불러오지 못했습니다: ${err2.message || err2}`;
          list.innerHTML = '';
        }
      }
    });

    async function renderList(rows){
      list.innerHTML = '';
      if(!rows.length){ msg.textContent = '업로드한 영상이 없습니다.'; return; }

      // 타이틀 보강(oEmbed) — 타이틀 없는 항목만 병렬 보강
      const filled = await Promise.all(rows.map(async (v)=>{
        if(v.title && v.title.trim()) return v;
        const t = await fetchTitleFallback(v.url);
        return { ...v, title: t || v.url };
      }));

      for(const v of filled){
        const el = document.createElement('label');
        el.style.cssText = 'display:flex;gap:8px;align-items:flex-start;background:#1b1b1b;border:1px solid #333;border-radius:8px;padding:10px;';
        el.innerHTML = `
          <input type="radio" name="sel" value="${v.id}" style="margin-top:4px;">
          <div style="display:flex;flex-direction:column;gap:4px;overflow:hidden;">
            <div style="font-weight:700;">${escapeHTML(v.title || v.url)}</div>
            <div style="font-size:12px;color:#9aa0a6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHTML(v.url)}</div>
          </div>
        `;
        el.querySelector('input').addEventListener('change', (e)=> selectedId = e.target.value);
        list.appendChild(el);
      }
    }

    async function fetchTitleFallback(url){
      try{
        const r = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        if(!r.ok) return url;
        const j = await r.json();
        return j.title || url;
      }catch(e){ return url; }
    }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    document.getElementById('btnDelete').addEventListener('click', async ()=>{
      if(!selectedId){ msg.textContent = '삭제할 영상을 선택하세요.'; return; }
      if(!confirm('정말 삭제하시겠습니까?')) return;
      try{
        await deleteDoc(doc(db,'videos', selectedId));
        msg.textContent = '삭제되었습니다. 새로고침합니다.';
        location.reload();
      }catch(e){
        msg.textContent = `삭제 실패: ${e.message||e}`;
      }
    });
  </script>
</body>
</html>
