<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>업로드영상 - Copytube</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube 홈으로">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
    </div>
  </header>

  <main class="intro" style="align-items:flex-start; padding-top:96px;">
    <div style="max-width:720px;width:100%;text-align:left;">
      <h2>업로드한 영상</h2>
      <div id="msg" class="welcome" style="margin:8px 0 12px;"></div>

      <div id="list" style="display:flex;flex-direction:column;gap:8px;"></div>

      <div style="margin-top:14px;display:flex;gap:8px;">
        <button id="btnDelete" style="padding:10px 14px;border:0;border-radius:8px;background:#dc2626;color:#fff;cursor:pointer;">선택 삭제</button>
        <a href="./" class="link" style="align-self:center;">← 돌아가기</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from './js/auth.js';
    import {
      collection, query, where, orderBy, getDocs, deleteDoc, doc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $ = (s)=>document.querySelector(s);
    const list = $('#list');
    const msg  = $('#msg');
    let selectedId = null;

    onAuthStateChanged(auth, async (user)=>{
      $('#signupLink').classList.toggle('hidden', !!user);
      $('#signinLink').classList.toggle('hidden', !!user);
      $('#welcome').textContent = user ? `안녕하세요, ${user.displayName||'회원'}님` : '';

      if(!user){ msg.textContent = '로그인 후 이용하세요.'; return; }
      msg.textContent = '불러오는 중...';

      const q = query(
        collection(db,'videos'),
        where('uid','==',user.uid),
        orderBy('createdAt','desc'),
      );
      const snap = await getDocs(q);
      list.innerHTML = '';
      if(snap.empty){ msg.textContent = '업로드한 영상이 없습니다.'; return; }

      // 병렬로 타이틀 보강
      const rows = await Promise.all(snap.docs.map(async (d)=>{
        const v = d.data();
        const title = v.title || await fetchTitleFallback(v.url);
        return { id: d.id, url: v.url, title };
      }));

      for(const row of rows){
        const el = document.createElement('label');
        el.style.cssText = 'display:flex;gap:8px;align-items:flex-start;background:#1b1b1b;border:1px solid #333;border-radius:8px;padding:10px;';
        el.innerHTML = `
          <input type="radio" name="sel" value="${row.id}" style="margin-top:4px;">
          <div style="display:flex;flex-direction:column;gap:4px;overflow:hidden;">
            <div style="font-weight:700;">${escapeHTML(row.title)}</div>
            <div style="font-size:12px;color:#9aa0a6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHTML(row.url)}</div>
          </div>
        `;
        el.querySelector('input').addEventListener('change', (e)=> selectedId = e.target.value);
        list.appendChild(el);
      }
      msg.textContent = '';
    });

    async function fetchTitleFallback(url){
      try{
        const r = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        if(!r.ok) return url;
        const j = await r.json();
        return j.title || url;
      }catch(e){ return url; }
    }
    function escapeHTML(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    document.getElementById('btnDelete').addEventListener('click', async ()=>{
      if(!selectedId){ msg.textContent = '삭제할 영상을 선택하세요.'; return; }
      if(!confirm('정말 삭제하시겠습니까?')) return;
      try{
        await deleteDoc(doc(db,'videos', selectedId));
        msg.textContent = '삭제되었습니다. 새로고침합니다.';
        location.reload();
      }catch(e){
        msg.textContent = `삭제 실패: ${e.message||e}`;
      }
    });
  </script>
</body>
</html>
