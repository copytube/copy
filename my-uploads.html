<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>업로드영상 - Copytube</title>
  <link rel="stylesheet" href="css/style.css"/>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube 홈으로">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
    </div>
  </header>

  <main class="intro" style="align-items:flex-start; padding-top:96px;">
    <div style="max-width:900px;width:100%;text-align:left;">
      <h2 style="display:flex;align-items:center;gap:10px;">
        업로드한 영상
        <small id="adminBadge" class="welcome hidden" style="font-weight:700;color:#9ef01a;">
          (관리자 모드: 전체 표시)
        </small>
      </h2>

      <div id="msg" class="welcome" style="margin:8px 0 12px;"></div>
      <div id="list" style="display:flex;flex-direction:column;gap:8px;"></div>

      <div style="margin-top:14px;display:flex;gap:8px;">
        <button id="btnDelete" style="padding:10px 14px;border:0;border-radius:8px;background:#dc2626;color:#fff;cursor:pointer;">
          선택 삭제
        </button>
        <a href="./" class="link" style="align-self:center;">← 돌아가기</a>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from './js/auth.js';
    import {
      collection, query, where, getDocs, deleteDoc, doc, getDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const $ = (s)=>document.querySelector(s);
    const list = $('#list');
    const msg  = $('#msg');
    const adminBadge = $('#adminBadge');
    let selectedId = null;

    onAuthStateChanged(auth, async (user)=>{
      $('#signupLink').classList.toggle('hidden', !!user);
      $('#signinLink').classList.toggle('hidden', !!user);
      $('#welcome').textContent = user ? `안녕하세요, ${user.displayName||'회원'}님` : '';

      if(!user){ msg.textContent = '로그인 후 이용하세요.'; list.innerHTML=''; return; }

      msg.textContent = '불러오는 중...';

      const admin = await isAdmin(user.uid);
      adminBadge.classList.toggle('hidden', !admin);

      try{
        const rows = await fetchRowsNoIndex(user.uid, admin); // 인덱스 없이도 동작
        renderListImmediate(rows);           // 먼저 URL로 즉시 렌더
        backfillTitles(rows).catch(()=>{});  // 제목은 배경에서 보강
        msg.textContent = rows.length ? '' : '영상이 없습니다.';
      }catch(err){
        console.error(err);
        msg.textContent = `목록을 불러오지 못했습니다: ${err.message||err}`;
        list.innerHTML = '';
      }
    });

    async function isAdmin(uid){
      try{
        const s = await getDoc(doc(db,'admins', uid));
        return s.exists();
      }catch{ return false; }
    }

    // 인덱스 없이 가져와 클라이언트에서 정렬
    async function fetchRowsNoIndex(uid, adminMode){
      let snap;
      if (adminMode){
        snap = await getDocs(collection(db,'videos'));       // 전체
      }else{
        const qMine = query(collection(db,'videos'), where('uid','==',uid)); // 내 것만
        snap = await getDocs(qMine);
      }
      const rows = snap.docs.map(d => ({ id:d.id, ...d.data() }));
      rows.sort((a,b)=> toMs(b.createdAt) - toMs(a.createdAt)); // 최신순
      return rows;
    }

    function toMs(t){
      try { return t?.toMillis ? t.toMillis() : (typeof t==='number' ? t : 0); }
      catch { return 0; }
    }

    // 1) 즉시 렌더(제목 없으면 URL로 먼저)
    function renderListImmediate(rows){
      list.innerHTML = '';
      for (const v of rows){
        const el = document.createElement('label');
        el.dataset.id = v.id;
        el.style.cssText = 'display:flex;gap:8px;align-items:flex-start;background:#1b1b1b;border:1px solid #333;border-radius:8px;padding:10px;';
        el.innerHTML = `
          <input type="radio" name="sel" value="${v.id}" style="margin-top:4px;">
          <div style="display:flex;flex-direction:column;gap:4px;overflow:hidden;">
            <div class="title" style="font-weight:700;">${escapeHTML(v.title || v.url)}</div>
            <div style="font-size:12px;color:#9aa0a6;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
              ${escapeHTML(v.url)}${v.uid ? ' • 업로더: '+escapeHTML(v.uid) : ''}
            </div>
          </div>
        `;
        el.querySelector('input').addEventListener('change', (e)=> selectedId = e.target.value);
        list.appendChild(el);
      }
    }

    // 2) 제목 보강을 비동기로 수행(렌더 차단 X)
    async function backfillTitles(rows){
      const tasks = rows.map(async v=>{
        if (v.title && v.title.trim()) return;
        const t = await fetchTitle(v.url);
        if (!t) return;
        const node = list.querySelector(`label[data-id="${v.id}"] .title`);
        if (node) node.textContent = t;
      });
      await Promise.allSettled(tasks);
    }

    async function fetchTitle(url){
      try{
        const r = await fetch(`https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`);
        if(!r.ok) return '';
        const j = await r.json();
        return j.title || '';
      }catch{ return ''; }
    }

    function escapeHTML(s){
      return String(s).replace(/[&<>"']/g, m=>({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      }[m]));
    }

    document.getElementById('btnDelete').addEventListener('click', async ()=>{
      if(!selectedId){ msg.textContent = '삭제할 영상을 선택하세요.'; return; }
      if(!confirm('정말 삭제하시겠습니까?')) return;
      try{
        await deleteDoc(doc(db,'videos', selectedId));
        msg.textContent = '삭제되었습니다. 새로고침합니다.';
        location.reload();
      }catch(e){
        msg.textContent = `삭제 실패: ${e.message||e}`;
      }
    });
  </script>
</body>
</html>
