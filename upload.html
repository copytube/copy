<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>추천영상 등록 - Copytube</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    /* 페이지 전용(레이아웃/컨트롤) — 카테고리 간격은 style.css의 .cat-compact 사용 */
    main { max-width:960px; margin:96px auto 40px; padding:0 16px; text-align:left; }
    label { display:block; margin-top:10px; font-size:14px; }
    textarea, input[type="text"]{
      width:100%; padding:10px; margin-top:6px; box-sizing:border-box;
      border:1px solid #333; border-radius:8px; background:#000; color:#fff;
      font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    textarea#bulkUrls{ min-height:7.5em; resize:vertical; } /* 대략 3줄보다 조금 큰 기본 */

    .row{ display:flex; gap:10px; align-items:center; }
    .row.wrap{ flex-wrap:wrap; }

    /* 순서 라디오 2개: 데스크톱 가로, 모바일 세로 + 우측에 버튼 */
    .order-wrap{ display:flex; gap:10px; align-items:center; }
    .order-col{ display:flex; flex-direction:column; gap:6px; }
    .radio-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:10px; border:1px solid #2a2a2a; background:#111; color:#ddd;
      cursor:pointer; font-weight:700; min-width:180px; justify-content:center;
    }
    .radio-pill input{ margin:0; }
    @media (max-width:640px){
      .order-wrap{ align-items:stretch; }
      .order-col{ width: 180px; } /* 라디오 두 개 세로 폭 고정 */
    }

    .btn-primary{
      padding:12px 16px; border:0; border-radius:10px; background:#4ea1ff;
      color:#fff; font-weight:800; cursor:pointer;
    }
    .btn-success{
      padding:14px 16px; border:0; border-radius:12px; background:#22c55e;
      color:#fff; font-weight:800; cursor:pointer; width:100%;
    }
    .btn-compact{ padding:10px 12px; }

    /* 모바일에서 붙여넣기 버튼이 오른쪽으로 밀리는 것 방지 */
    .paste-col{ flex:1 1 480px; }
    @media (max-width:640px){
      .order-wrap{ flex-wrap:nowrap; }
      .paste-col{ flex:1 1 auto; min-width:180px; }
    }

    details{ margin-top:10px; }
    details summary{ cursor:pointer; color:#9aa0a6; }
    .help-body{ font-size:13px; color:#cfcfcf; background:#0b0b0b; border:1px solid #333; border-radius:8px; padding:10px; margin-top:8px; line-height:1.5; }

    /* 카테고리 타이틀/박스 간 여백 살짝 축소 */
    .cats-title{ margin-top:14px; margin-bottom:6px; font-weight:800; }
  </style>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a href="./"><img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/></a>
    </div>
    <div class="right">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
    </div>
  </header>

  <!-- cat-compact: 카테고리 간격을 인덱스와 동일하게 타이트하게 -->
  <main class="intro cat-compact" style="align-items:flex-start;">
    <div style="width:100%; max-width:960px;">
      <h2>추천영상 등록</h2>

      <label> YouTube 공유 URLs (한 줄에 하나씩)
        <textarea id="bulkUrls" placeholder="https://youtu.be/aaa&#10;https://www.youtube.com/watch?v=bbb&#10;..."></textarea>
      </label>

      <div class="order-wrap" style="margin:10px 0 8px;">
        <div class="order-col">
          <label class="radio-pill"><input type="radio" name="order" value="bottom" checked> 아래부터 등록</label>
          <label class="radio-pill"><input type="radio" name="order" value="top"> 위부터 등록</label>
        </div>
        <div class="paste-col">
          <button id="btnPaste" class="btn-success">클립보드 붙여넣기</button>
        </div>
      </div>

      <div class="row" style="margin:6px 0 10px;">
        <button id="btnSubmitTop" class="btn-primary" style="width:100%;">등록</button>
      </div>

      <details id="help" open>
        <summary>붙여넣기 도움말</summary>
        <div class="help-body">
          • <b>URL 입력칸</b>에 직접 붙여넣거나, <b>오른쪽 “클립보드 붙여넣기”</b> 버튼을 사용하세요. (브라우저/OS 허용 필요)<br/>
          • <b>URL 다중등록:</b> 입력칸에 <b>한 줄에 1개 URL</b>씩 붙여넣고, <b>카테고리 선택 후 “등록”</b>을 누르면 한 번에 모두 등록됩니다.<br/>
          • 위의 <b>“아래부터/위부터 등록”</b> 옵션으로 등록 순서를 결정합니다. (피드는 최신순이므로 시리즈는 보통 <b>아래부터 등록</b>이 자연스럽습니다.)<br/><br/>
          • <b>HTTPS</b> 환경에서만 동작합니다. (GitHub Pages OK)<br/>
          • <b>iPhone/iPad (iOS 16+)</b>: 처음 붙여넣기 때 <i>“이 앱에서 붙여넣기 허용”</i> 팝업에서 <b>허용</b>을 선택하세요.<br/>
          • <b>안드로이드/데스크탑 Chrome</b>: <b>설정 → 사이트 설정 → 클립보드</b>에서 <code>https://copytube.github.io</code>를 <b>허용</b>으로 바꾸세요.<br/>
          • 또는 <b>길게 누르기 → 붙여넣기</b>나 <code>Ctrl/⌘+V</code>를 사용해도 됩니다.<br/><br/>
          • <b>개인자료1/2</b>는 <b>로컬저장소</b>에 저장되며 공유되지 않습니다. 이름 변경 가능하고, 카테고리 위치를 상단으로 바꾸는 것도 가능합니다.
        </div>
      </details>

      <h3 class="cats-title">카테고리(최대 3개)</h3>
      <div id="catsUpload"><!-- JS로 그룹 렌더링 --></div>

      <div class="row" style="margin-top:12px;">
        <button id="btnSubmitBottom" class="btn-primary" style="width:100%;">등록</button>
      </div>

      <div id="msg" class="welcome" style="margin-top:10px;"></div>
    </div>
  </main>

  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged } from './js/auth.js';
    import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { CATEGORY_GROUPS } from './js/categories.js?v=20250818';

    const $ = s => document.querySelector(s);
    const msg = $('#msg');

    /* 로그인 상태 표시 */
    onAuthStateChanged(auth, (user)=>{
      $('#signupLink').classList.toggle('hidden', !!user);
      $('#signinLink').classList.toggle('hidden', !!user);
      $('#welcome').textContent = user ? `안녕하세요, ${user.displayName||'회원'}님` : '';
      if(!user){ msg.textContent = '로그인 후 등록 가능합니다.'; }
    });

    /* 개인자료 이름(로컬) */
    function getPersonalLabels(){
      try{ return JSON.parse(localStorage.getItem('personalLabels')||'{}'); }
      catch{ return {}; }
    }
    function personalDefaultLabel(key){
      return key==='personal1' ? '자료1' : (key==='personal2' ? '자료2' : '');
    }

    /* 카테고리 렌더 (.cat-compact 스타일 적용은 main에 클래스가 있어서 자동) */
    const catsBox = $('#catsUpload');
    function renderGroups(){
      const labels = getPersonalLabels();
      const html = CATEGORY_GROUPS.map(g=>{
        const kids = g.children.map(c=>{
          const isPersonal = (g.key==='personal');
          const defaultLabel = personalDefaultLabel(c.value) || c.label;
          const labelText = isPersonal && labels[c.value] ? labels[c.value] : defaultLabel;
          return `<label><input type="checkbox" class="cat" value="${c.value}"> ${labelText}</label>`;
        }).join('');
        const legend = (g.key==='personal')
          ? `${g.label} <span class="subnote">(로컬저장소)</span>` : g.label;
        return `
          <fieldset class="group" data-key="${g.key}">
            <legend>${legend}</legend>
            <div class="child-grid">${kids}</div>
          </fieldset>`;
      }).join('');
      catsBox.innerHTML = html;
    }
    renderGroups();

    /* 붙여넣기 */
    async function pasteFromClipboard(){
      const ta = $('#bulkUrls');
      try{
        const txt = await navigator.clipboard.readText();
        if(txt && (!ta.value || ta.value.trim()==='')) ta.value = txt;
      }catch(e){
        alert('브라우저에서 클립보드 읽기를 허용해야 합니다.\n설정 → 사이트 설정 → 클립보드에서 허용으로 변경해 주세요.');
      }
    }
    $('#btnPaste').addEventListener('click', pasteFromClipboard);

    /* URL → id 추출 */
    function extractId(url){
      const m = String(url).trim().match(/(?:youtu\.be\/|v=|shorts\/)([^?&/]+)/);
      return m ? m[1] : '';
    }

    /* 제출 */
    async function submitAll(){
      msg.textContent = '검증 중...';
      const user = auth.currentUser;
      if(!user){ msg.textContent = '로그인 후 이용하세요.'; return; }

      // 선택 카테고리
      const selected = Array.from(document.querySelectorAll('.cat:checked')).map(c=>c.value);
      // 개인자료는 서버 업로드 제외
      const cats = selected.filter(v=> v!=='personal1' && v!=='personal2');
      if(cats.length === 0){ msg.textContent = '카테고리를 1개 이상 선택하세요. (개인자료만 선택하면 서버에 업로드되지 않습니다)'; return; }
      if(cats.length > 3){ msg.textContent = '카테고리는 최대 3개까지 선택 가능합니다.'; return; }

      // URL 파싱
      const lines = $('#bulkUrls').value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if(lines.length === 0){ msg.textContent = 'URL을 입력해 주세요.'; return; }

      // 순서
      const order = (document.querySelector('input[name="order"]:checked')?.value || 'bottom');
      const list = (order==='bottom') ? lines : lines.slice().reverse();

      // 최종 확인 (시리즈 대량 등록시 실수 방지용)
      if(!confirm(`총 ${list.length}개 영상을 선택한 카테고리(${cats.join(', ')})로 등록합니다. 진행할까요?`)){ msg.textContent='취소됨'; return; }

      msg.textContent = '등록 중...';
      let ok=0, fail=0;

      for(const raw of list){
        const id = extractId(raw);
        if(!id){ fail++; continue; }
        try{
          await addDoc(collection(db,'videos'), {
            url: raw, title: raw, categories: cats, uid: user.uid, createdAt: serverTimestamp()
          });
          ok++;
        }catch(e){ console.error(e); fail++; }
      }

      msg.textContent = `완료: ${ok}개 성공, ${fail}개 실패`;
      if(ok>0){ $('#bulkUrls').value=''; }
    }
    $('#btnSubmitTop').addEventListener('click', submitAll);
    $('#btnSubmitBottom').addEventListener('click', submitAll);
  </script>
</body>
</html>
