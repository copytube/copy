<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>copytube - Firebase 점검</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 0; padding: 24px; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; }
    button { padding: 10px 14px; border: 0; border-radius: 8px; cursor: pointer; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    pre { background:#f8fafc; padding:12px; border-radius:8px; overflow:auto; }
    .ok { color: #16a34a; } .warn { color:#d97706; } .err { color:#dc2626; }
    small { color:#6b7280; }
  </style>
</head>
<body>
  <h1>Firebase 점검</h1>
  <div class="card">
    <div id="basic"></div>
    <small>이 페이지는 <code>js/firebase-init.js</code>를 import하여 같은 설정으로 테스트합니다.</small>
  </div>

  <div class="card">
    <h3>연결/상태</h3>
    <div id="status">초기화 중…</div>
  </div>

  <div class="card">
    <h3>Firestore 테스트</h3>
    <div class="row">
      <button id="btnRead">읽기 테스트 (usernames/healthcheck)</button>
      <button id="btnWrite">쓰기 테스트 (로그인 안 된 상태면 거부가 정상)</button>
    </div>
    <pre id="log">대기 중…</pre>
    <small>
      규칙이 정상이라면:<br>
      • <b>읽기</b>는 항상 성공해야 합니다 (<code>allow read: if true;</code>)<br>
      • <b>쓰기</b>는 <u>로그인 안 된 상태</u>에서 <span class="warn">permission-denied</span> 가 나오는 게 정상입니다 (<code>allow create: if request.auth != null;</code>)<br>
      • 회원가입/로그인 후 다시 쓰기를 누르면 성공해야 합니다.
    </small>
  </div>

  <script type="module">
    import { app, auth, db } from './js/firebase-init.js';
    import {
      onAuthStateChanged
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
    import {
      doc, getDoc, setDoc, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

    const $ = (id)=>document.getElementById(id);
    const basic = $('basic');
    const status = $('status');
    const log = $('log');
    const btnRead = $('btnRead');
    const btnWrite = $('btnWrite');

    // 기본 정보 표시
    basic.innerHTML = `
      <div>projectId: <b>${app.options?.projectId || '(알 수 없음)'}</b></div>
      <div>authDomain: <b>${app.options?.authDomain || '(알 수 없음)'}</b></div>
      <div>apiKey: <b>${(app.options?.apiKey||'').slice(0,7)}…</b></div>
    `;

    // 로그인 상태 감시
    onAuthStateChanged(auth, (user) => {
      if (user) {
        status.innerHTML = `상태: <span class="ok">로그인됨</span> (uid: <code>${user.uid}</code>, displayName: <code>${user.displayName||''}</code>)`;
      } else {
        status.innerHTML = `상태: <span class="warn">로그아웃됨</span>`;
      }
    });

    function append(msg, cls='') {
      const line = document.createElement('div');
      if (cls) line.className = cls;
      line.textContent = msg;
      log.append(line);
    }

    // 읽기 테스트 (항상 성공해야 함: allow read: if true)
    btnRead.addEventListener('click', async ()=>{
      log.textContent = '';
      append('[READ] usernames/healthcheck 시도…');
      try {
        const ref = doc(db, 'usernames', 'healthcheck');
        const snap = await getDoc(ref);
        append(`→ 성공. 존재여부: ${snap.exists()}`, 'ok');
      } catch (e) {
        append(`→ 실패: ${e.code || e.name} - ${e.message}`, 'err');
      }
    });

    // 쓰기 테스트 (로그인 전에는 permission-denied가 정상)
    btnWrite.addEventListener('click', async ()=>{
      log.textContent = '';
      const key = '__check_'+Date.now();
      append(`[WRITE] usernames/${key} 생성 시도… (로그인 안 되어 있으면 거부가 정상)`);
      try {
        const ref = doc(db, 'usernames', key);
        await setDoc(ref, { reserved:true, at: serverTimestamp(), via:'check.html' });
        append('→ 성공 (현재 로그인된 상태이므로 쓰기 허용)', 'ok');
      } catch (e) {
        if ((e.code||'').includes('permission-denied')) {
          append('→ permission-denied (로그인 안 되어 있어 거부) — 규칙 정상 동작', 'warn');
        } else {
          append(`→ 실패: ${e.code || e.name} - ${e.message}`, 'err');
        }
      }
    });
  </script>
</body>
</html>
