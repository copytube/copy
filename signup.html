<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>회원가입 - copytube</title>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src 'self'
      https://identitytoolkit.googleapis.com
      https://securetoken.googleapis.com
      https://firebaseinstallations.googleapis.com
      https://www.googleapis.com
      https://www.gstatic.com
      https://firestore.googleapis.com;
    img-src 'self' data:;
    frame-src https://www.youtube.com https://www.youtube-nocookie.com;
    script-src 'self' https://www.gstatic.com 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    object-src 'none';
    base-uri 'self';
  ">
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    main { max-width:420px; margin:96px auto 40px; padding:0 16px; }
    label { display:block; margin-top:14px; font-size:14px; }
    input { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; border:1px solid #333; border-radius:6px; background:#000; color:#fff; }
    button { margin-top:18px; width:100%; padding:12px; border:0; border-radius:8px; background:#0366d6; color:#fff; font-weight:600; cursor:pointer; }
    .msg { margin-top:10px; font-size:13px; color:#ccc; white-space:pre-line; min-height:1.2em; }
  </style>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a href="./"><img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/></a>
    </div>
    <div class="right">
      <a class="link" href="signin.html">Sign in</a>
    </div>
  </header>

  <main>
    <h2>회원가입</h2>
    <p><small>닉네임과 비밀번호만 입력하면 됩니다.</small></p>

    <label>닉네임
      <input id="nickname" placeholder="예: coolboy" />
    </label>
    <label>비밀번호
      <input id="password" type="password" placeholder="4자 이상" autocomplete="new-password"/>
    </label>
    <button id="submitBtn">가입하기</button>
    <div class="msg" id="msg"></div>
    <p style="margin-top:12px;">이미 계정이 있으신가요? <a class="link" href="signin.html">Sign in</a></p>
  </main>

  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module">
    import {
      auth, db, createUserWithEmailAndPassword, updateProfile,
      runTransaction, doc, deleteUser, onAuthStateChanged
    } from './js/auth.js';
    import { sanitizeNickname } from './js/auth.js';

    const $ = (id) => document.getElementById(id);
    const msg = $('msg');

    async function waitAuthReady() {
      if (typeof auth.authStateReady === 'function') { await auth.authStateReady(); return; }
      await new Promise((resolve) => { const unsub = onAuthStateChanged(auth, () => { unsub(); resolve(); }); });
    }

    $('submitBtn').addEventListener('click', async () => {
      msg.textContent = '처리 중...';
      const rawNick = $('nickname').value.trim();
      const password = $('password').value;

      if (!rawNick || !password) { msg.textContent = '닉네임과 비밀번호를 입력해 주세요.'; return; }
      if (password.length < 4)    { msg.textContent = '비밀번호는 4자 이상으로 해주세요.'; return; }

      const nickname = sanitizeNickname(rawNick);
      if (!nickname) { msg.textContent = '닉네임은 영문/숫자/한글/[-_.]만 허용, 길이 2~20자입니다.'; return; }

      const pseudoEmail = `${nickname.toLowerCase()}@copytube.local`;
      let createdUser = null;

      try {
        const cred = await createUserWithEmailAndPassword(auth, pseudoEmail, password);
        createdUser = cred.user;

        await waitAuthReady();
        if (auth.currentUser) { await auth.currentUser.getIdToken(true); }

        await runTransaction(db, async (tx) => {
          const key = nickname.toLowerCase();
          const ref = doc(db, 'usernames', key);
          const snap = await tx.get(ref);
          if (snap.exists()) throw new Error('이미 사용 중인 닉네임입니다.');
          tx.set(ref, { reserved: true, uid: createdUser.uid, createdAt: Date.now() });
        });

        await updateProfile(createdUser, { displayName: nickname });

        msg.textContent = '회원가입 완료! 로그인 페이지로 이동합니다...';
        setTimeout(() => { location.href = 'signin.html'; }, 600);

      } catch (e) {
        if (createdUser) { try { await deleteUser(createdUser); } catch (_) {} }
        console.error(e);
        msg.textContent = `오류: ${e.message || e.code || e}`;
      }
    });
  </script>
</body>
</html>
