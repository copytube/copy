<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>회원가입 - copytube</title>
  <style>
    body { margin:0; font-family: system-ui, Arial, sans-serif; }
    main { max-width:420px; margin:40px auto; padding:0 16px; }
    label { display:block; margin-top:14px; font-size:14px; }
    input { width:100%; padding:10px; margin-top:6px; box-sizing:border-box; border:1px solid #ccc; border-radius:6px; }
    button { margin-top:18px; width:100%; padding:12px; border:0; border-radius:8px; background:#0366d6; color:#fff; font-weight:600; cursor:pointer; }
    .msg { margin-top:10px; font-size:13px; color:#333; white-space:pre-line; }
    a { color:#0366d6; text-decoration:none; }
    small { color:#666; }
  </style>
</head>
<body>
  <main>
    <h2>회원가입</h2>
    <p><small>아이디는 이메일 또는 닉네임(이메일 형식 아님) 모두 가능합니다.</small></p>

    <label>아이디 (이메일 또는 닉네임)
      <input id="loginId" placeholder="예: niceguy 또는 niceguy@example.com" autocomplete="username"/>
    </label>

    <label>표시 이름(닉네임)
      <input id="nickname" placeholder="화면에 보일 이름" />
    </label>

    <label>비밀번호
      <input id="password" type="password" placeholder="8자 이상" autocomplete="new-password"/>
    </label>

    <button id="submitBtn">가입하기</button>
    <div class="msg" id="msg"></div>

    <p style="margin-top:12px;">이미 계정이 있으신가요? <a href="signin.html">Sign in</a></p>
  </main>

  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module">
    import { auth, db, createUserWithEmailAndPassword, updateProfile, runTransaction, doc } from './js/auth.js';
    import { normalizeLoginId, sanitizeNickname } from './js/auth.js';

    const $ = (id) => document.getElementById(id);
    const msg = $('msg');

    $('submitBtn').addEventListener('click', async () => {
      msg.textContent = '처리 중...';
      const rawId = $('loginId').value.trim();
      const rawNick = $('nickname').value.trim();
      const password = $('password').value;

      if (!rawId || !rawNick || !password) {
        msg.textContent = '모든 필드를 입력해 주세요.';
        return;
      }
      if (password.length < 8) {
        msg.textContent = '비밀번호는 8자 이상으로 해주세요.';
        return;
      }

      const { emailLike, idType } = normalizeLoginId(rawId);
      const nickname = sanitizeNickname(rawNick);
      if (!nickname) {
        msg.textContent = '닉네임은 영문/숫자/한글/[-_.]만 허용, 길이 2~20자입니다.';
        return;
      }

      try {
        // 닉네임 중복 방지: usernames/{nicknameLower} 점유
        await runTransaction(db, async (tx) => {
          const key = nickname.toLowerCase();
          const ref = doc(db, 'usernames', key);
          const snap = await tx.get(ref);
          if (snap.exists()) throw new Error('이미 사용 중인 닉네임입니다.');
          tx.set(ref, { reserved: true, createdAt: Date.now() });
        });

        // 사용자 생성
        const cred = await createUserWithEmailAndPassword(auth, emailLike, password);
        await updateProfile(cred.user, { displayName: nickname });

        // (선택) users/{uid}에 프로필 기록 — 필요 시 확장
        // Firestore 보안규칙을 엄격히 사용하려면 setDoc 등을 추가하세요.

        msg.textContent = '회원가입 완료! 로그인 페이지로 이동합니다...';
        setTimeout(() => { location.href = 'signin.html'; }, 600);
      } catch (e) {
        msg.textContent = `오류: ${e.message}`;
      }
    });
  </script>
</body>
</html>
