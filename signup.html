<script type="module">
  import {
    auth, db,
    createUserWithEmailAndPassword,
    updateProfile,
    runTransaction, doc,
    deleteUser
  } from './js/auth.js';
  import { sanitizeNickname } from './js/auth.js';

  const $ = (id) => document.getElementById(id);
  const msg = $('msg');

  $('submitBtn').addEventListener('click', async () => {
    msg.textContent = '처리 중...';

    const rawNick = $('nickname').value.trim();
    const password = $('password').value;

    if (!rawNick || !password) { msg.textContent = '닉네임과 비밀번호를 입력해 주세요.'; return; }
    if (password.length < 4) { msg.textContent = '비밀번호는 4자 이상으로 해주세요.'; return; }

    const nickname = sanitizeNickname(rawNick);
    if (!nickname) { msg.textContent = '닉네임은 영문/숫자/한글/[-_.]만 허용, 길이 2~20자입니다.'; return; }

    const pseudoEmail = `${nickname.toLowerCase()}@copytube.local`;

    let createdUser = null;
    try {
      // 1) 사용자 먼저 생성(→ 이 시점부터 request.auth != null)
      const cred = await createUserWithEmailAndPassword(auth, pseudoEmail, password);
      createdUser = cred.user;

      // 2) 닉네임 점유 (트랜잭션)
      await runTransaction(db, async (tx) => {
        const key = nickname.toLowerCase();
        const ref = doc(db, 'usernames', key);
        const snap = await tx.get(ref);
        if (snap.exists()) throw new Error('이미 사용 중인 닉네임입니다.');
        tx.set(ref, { reserved: true, uid: createdUser.uid, createdAt: Date.now() });
      });

      // 3) 표시 이름 업데이트
      await updateProfile(createdUser, { displayName: nickname });

      msg.textContent = '회원가입 완료! 로그인 페이지로 이동합니다...';
      setTimeout(() => { location.href = 'signin.html'; }, 600);

    } catch (e) {
      // 닉네임 점유 실패 등의 경우, 방금 만든 계정 롤백
      if (createdUser) {
        try { await deleteUser(createdUser); } catch (_) { /* 이미 삭제/만료일 수 있음 */ }
      }
      msg.textContent = `오류: ${e.message}`;
    }
  });
</script>
