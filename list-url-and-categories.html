<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>URL & 카테고리 목록 - Copytube</title>
  <link rel="stylesheet" href="css/style.css"/>
  <style>
    main { padding-top:96px; }
    .wrap { max-width:1100px; margin:0 auto; padding:0 16px; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:8px 0 14px; flex-wrap:wrap; }
    .count { color:#9aa0a6; font-size:14px; }
    table { width:100%; border-collapse:collapse; background:#0b0b0b; border:1px solid #333; border-radius:10px; overflow:hidden; }
    th, td { padding:10px 12px; border-bottom:1px solid #222; vertical-align:top; }
    th { background:#111; color:#ddd; text-align:left; font-weight:700; }
    tr:hover td { background:#0f0f0f; }
    a.url { color:#4ea1ff; word-break:break-all; text-decoration:none; }
    .title { color:#cfcfcf; font-size:12px; margin-top:4px; }
    .cats { color:#ddd; }
    .chip { display:inline-block; background:#1b1b1b; border:1px solid #2a2a2a; border-radius:999px; padding:3px 9px; margin:2px 6px 2px 0; font-size:12px; }
    .hint { font-size:12px; color:#9aa0a6; margin-top:6px; white-space:pre-line; }
    .actions{ display:flex; gap:8px; }
    .btn{ padding:8px 12px; border:1px solid #333; background:#1b1b1b; color:#fff; border-radius:8px; cursor:pointer; }
    .btn:hover{ background:#222; }
    .btn-small{ padding:8px 10px; font-size:13px; border-radius:8px; }
    .err{ color:#f87171; }
    .ok{ color:#34d399; }
    .selects{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .selects select{ min-width:140px; background:#0f0f0f; color:#fff; border:1px solid #2a2a2a; border-radius:6px; padding:6px; }
    .rowmsg{ font-size:12px; margin-top:6px; color:#9aa0a6; }
    .pager { display:flex; flex-wrap:wrap; gap:6px; margin-top:12px; }
    .pager .pbtn{
      min-width:34px; text-align:center; padding:6px 10px; border:1px solid #333; background:#1b1b1b;
      color:#fff; border-radius:8px; cursor:pointer;
    }
    .pager .pbtn[disabled]{ opacity:.5; cursor:default; }
    .pager .current{ background:#2a2a2a; font-weight:700; }
    @media (max-width:560px){ th:nth-child(4), td:nth-child(4){ display:block; } }
  </style>
</head>
<body>
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube 홈으로">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right" style="position:relative;">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
      <button id="menuBtn" class="icon hidden" aria-label="menu">三</button>
      <div id="dropdownMenu" class="dropdown hidden" role="menu" aria-hidden="true">
        <button id="btnGoCategory" class="menu-strong" type="button">카테고리 선택</button>
        <button id="btnMyUploads" type="button">업로드영상</button>
        <button id="btnSignOut" type="button">Sign out</button>
        <button id="btnGoUpload" class="menu-strong" type="button">추천영상등록</button>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <h2>현재 등록된 URL & 카테고리 (수정 가능)</h2>
      <div class="toolbar">
        <div id="status" class="count">불러오는 중…</div>
        <div class="actions">
          <button id="btnReload" class="btn">새로고침</button>
        </div>
      </div>

      <table id="tbl">
        <thead>
          <tr>
            <th style="width:56px;">#</th>
            <th>URL / 제목</th>
            <th style="width:38%;">현재 카테고리</th>
            <th style="width:36%;">카테고리 변경</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="4" class="hint">읽는 중…</td></tr>
        </tbody>
      </table>

      <div id="pager" class="pager" aria-label="페이지 이동"></div>

      <p id="footnote" class="hint">
        * 모르는 슬러그는 <code>[slug]</code>로 표시됩니다. (예전 값일 수 있음)<br/>
        * 본인이 올리지 않은 영상은 **권한**에 따라 수정이 거부될 수 있습니다.
      </p>
    </div>
  </main>

  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/auth.js"></script>
  <script type="module" src="js/categories.js"></script>
  <script type="module">
    import { auth, db } from './js/firebase-init.js';
    import { onAuthStateChanged, signOut as fbSignOut } from './js/auth.js';
    import { CATEGORY_GROUPS, flattenPublicCategories } from './js/categories.js';
    import { collection, getDocs, orderBy, query, updateDoc, doc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    /* ------- 상단 드롭다운 공통 ------- */
    const signupLink   = document.getElementById("signupLink");
    const signinLink   = document.getElementById("signinLink");
    const welcome      = document.getElementById("welcome");
    const menuBtn      = document.getElementById("menuBtn");
    const dropdown     = document.getElementById("dropdownMenu");
    const btnGoCategory= document.getElementById("btnGoCategory");
    const btnMyUploads = document.getElementById("btnMyUploads");
    const btnSignOut   = document.getElementById("btnSignOut");
    const btnGoUpload  = document.getElementById("btnGoUpload");
    function openDropdown(){ dropdown.classList.remove("hidden"); requestAnimationFrame(()=> dropdown.classList.add("show")); dropdown.setAttribute('aria-hidden','false'); }
    function closeDropdown(){ dropdown.classList.remove("show"); setTimeout(()=> dropdown.classList.add("hidden"), 180); dropdown.setAttribute('aria-hidden','true'); }
    menuBtn?.addEventListener("click",(e)=>{ e.stopPropagation(); dropdown.classList.contains("hidden")?openDropdown():closeDropdown(); });
    document.addEventListener('pointerdown',(e)=>{ if (dropdown.classList.contains('hidden')) return; const inside=e.target.closest('#dropdownMenu,#menuBtn'); if(!inside) closeDropdown(); }, true);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDropdown(); });
    dropdown.addEventListener("click",(e)=> e.stopPropagation());
    btnGoCategory?.addEventListener("click",()=>{ location.href="./"; closeDropdown(); });
    btnMyUploads ?.addEventListener("click",()=>{ location.href="my-uploads.html"; closeDropdown(); });
    btnGoUpload   ?.addEventListener("click",()=>{ location.href="upload.html"; closeDropdown(); });
    btnSignOut    ?.addEventListener("click", async ()=>{ await fbSignOut(auth); location.reload(); });

    onAuthStateChanged(auth, (user)=>{
      const loggedIn = !!user;
      signupLink.classList.toggle("hidden", loggedIn);
      signinLink.classList.toggle("hidden", loggedIn);
      menuBtn.classList.toggle("hidden", !loggedIn);
      welcome.textContent = loggedIn ? `안녕하세요, ${user.displayName || '회원'}님` : "";
    });

    /* ------- 카테고리 라벨/옵션 ------- */
    const labelMap = new Map();
    for (const g of CATEGORY_GROUPS){ for (const c of g.children){ labelMap.set(c.value, c.label); } }
    const alias = {
      review:'그외', fun:'유머', variety_celeb:'예능·연예', animal:'동물',
      edu:'일반', common_life:'상식·생활팁', medical:'일반',
      cook_food:'요리/맛집', it:'정보·IT', product:'제품리뷰',
      nature_survival:'서바이벌', agri:'농어광공업', common:'상식', life:'생활팁'
    };
    function labelFor(slug){
      if (labelMap.has(slug)) return labelMap.get(slug);
      if (alias[slug]) return alias[slug] + ' [구]';
      return `[${slug}]`;
    }
    const PUBLIC_CATS = flattenPublicCategories(); // [{value,label}...]
    const ALLOWED = new Set(PUBLIC_CATS.map(c=>c.value));
    function buildOptions(){
      // optgroup으로 그룹화
      const groups = CATEGORY_GROUPS.filter(g=> !g.personal);
      let html = `<option value="">선택안함</option>`;
      for (const g of groups){
        html += `<optgroup label="${escapeHtml(g.label)}">` +
                g.children.map(c=>`<option value="${c.value}">${escapeHtml(c.label)}</option>`).join('') +
                `</optgroup>`;
      }
      return html;
    }
    const SELECT_OPTIONS_HTML = buildOptions();

    /* ------- 표 렌더/페이징 ------- */
    const tbody  = document.getElementById('tbody');
    const status = document.getElementById('status');
    const foot   = document.getElementById('footnote');
    const btnReload = document.getElementById('btnReload');
    const pager = document.getElementById('pager');

    const PAGE_SIZE = 30;
    let ALL_ROWS = []; // {id,url,title,categories,createdAt}
    let currentPage = 1;

    function withTimeout(promise, ms=12000){
      return Promise.race([
        promise,
        new Promise((_, reject)=> setTimeout(()=> reject(new Error('timeout')), ms))
      ]);
    }
    function toMs(createdAt){
      try{ return createdAt?.toMillis ? createdAt.toMillis() : (typeof createdAt==='number'? createdAt : 0); }
      catch{ return 0; }
    }
    async function fetchAllVideos(){
      try{
        const q1 = query(collection(db,'videos'), orderBy('createdAt','desc'));
        const snap = await withTimeout(getDocs(q1), 12000);
        return snap.docs.map(d=> ({ id:d.id, ...d.data() }));
      }catch(e1){
        console.warn('orderBy createdAt 실패, 폴백 시도:', e1);
        foot.innerHTML = `* 정렬 최적화 쿼리가 실패하여 폴백으로 불러왔습니다. 사유: <span class="err">${escapeHtml(e1.message||String(e1))}</span>`;
        const snap2 = await withTimeout(getDocs(collection(db,'videos')), 12000);
        const rows = snap2.docs.map(d=> ({ id:d.id, ...d.data() }));
        rows.sort((a,b)=> toMs(b.createdAt) - toMs(a.createdAt));
        return rows;
      }
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    function renderPager(){
      const total = ALL_ROWS.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      pager.innerHTML = '';
      const makeBtn = (label, page, disabled=false, isCurrent=false)=>{
        const b = document.createElement('button');
        b.className = 'pbtn' + (isCurrent ? ' current' : '');
        b.textContent = label;
        if (disabled) b.setAttribute('disabled','true');
        b.dataset.page = String(page);
        return b;
      };
      if (pages <= 12){
        for (let p=1;p<=pages;p++){
          pager.appendChild(makeBtn(String(p), p, false, p===currentPage));
        }
      }else{
        // condensed: 1 … (current-2..current+2) … last
        const add = (el)=> pager.appendChild(el);
        add(makeBtn('1',1,false, currentPage===1));
        if (currentPage > 4){ const dot=document.createElement('span'); dot.className='pbtn'; dot.textContent='…'; dot.setAttribute('disabled','true'); add(dot); }
        const start = Math.max(2, currentPage-2);
        const end   = Math.min(pages-1, currentPage+2);
        for (let p=start; p<=end; p++){ add(makeBtn(String(p), p, false, p===currentPage)); }
        if (currentPage < pages-3){ const dot=document.createElement('span'); dot.className='pbtn'; dot.textContent='…'; dot.setAttribute('disabled','true'); add(dot); }
        add(makeBtn(String(pages), pages, false, currentPage===pages));
      }
    }

    function renderPage(){
      const total = ALL_ROWS.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (currentPage > pages) currentPage = pages;

      const start = (currentPage-1) * PAGE_SIZE;
      const end   = Math.min(total, start + PAGE_SIZE);
      const slice = ALL_ROWS.slice(start, end);

      status.textContent = `${total}개 • ${currentPage}/${pages} 페이지`;
      if (!slice.length){
        tbody.innerHTML = `<tr><td colspan="4" class="hint">표시할 데이터가 없습니다.</td></tr>`;
        renderPager();
        return;
      }

      const rows = [];
      for (let i=0; i<slice.length; i++){
        const v = slice[i];
        const idx = start + i + 1;
        const url  = v?.url || '';
        const title= (v?.title || '').trim();
        const cats = Array.isArray(v?.categories) ? v.categories : [];
        const labels = cats.map(labelFor);
        const id = v.id;

        rows.push(`
          <tr id="row_${id}">
            <td>${idx}</td>
            <td>
              <a class="url" href="${escapeHtml(url)}" target="_blank" rel="noopener">${escapeHtml(url)}</a>
              <div class="title">${escapeHtml(title || '(제목 없음)')}</div>
            </td>
            <td class="cats" id="cats_${id}">
              ${labels.length ? labels.map(x=>`<span class="chip">${escapeHtml(x)}</span>`).join('') : '<span class="hint">없음</span>'}
            </td>
            <td>
              <div class="selects">
                <select class="catSel">${SELECT_OPTIONS_HTML}</select>
                <select class="catSel">${SELECT_OPTIONS_HTML}</select>
                <select class="catSel">${SELECT_OPTIONS_HTML}</select>
                <button class="btn btn-small convertBtn" data-id="${id}">카테고리변환</button>
              </div>
              <div class="rowmsg" id="msg_${id}"></div>
            </td>
          </tr>
        `);
      }
      tbody.innerHTML = rows.join('');
      attachRowHandlers();
      renderPager();
    }

    function attachRowHandlers(){
      tbody.querySelectorAll('.convertBtn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.id;
          const row = document.getElementById(`row_${id}`);
          const sels = Array.from(row.querySelectorAll('select.catSel'));
          const msg  = document.getElementById(`msg_${id}`);
          const catsCell = document.getElementById(`cats_${id}`);

          // 읽기
          const raw = sels.map(s=> s.value).filter(Boolean);
          // 중복 제거
          const dedup = [...new Set(raw)];
          if (dedup.length === 0){ msg.textContent = '최소 1개의 카테고리를 선택하세요.'; msg.className='rowmsg err'; return; }
          if (dedup.length > 3){ msg.textContent = '카테고리는 최대 3개까지 가능합니다.'; msg.className='rowmsg err'; return; }
          // 허용 검증
          for (const v of dedup){ if (!ALLOWED.has(v)){ msg.textContent = `허용되지 않는 값: ${v}`; msg.className='rowmsg err'; return; } }

          // 저장
          msg.textContent = '저장 중…'; msg.className='rowmsg';
          btn.disabled = true;
          try{
            await updateDoc(doc(db,'videos', id), { categories: dedup });
            // 모델 업데이트
            const idx = ALL_ROWS.findIndex(x=> x.id === id);
            if (idx >= 0){ ALL_ROWS[idx].categories = dedup; }
            // 뷰 업데이트
            const chips = dedup.map(v=> `<span class="chip">${escapeHtml(labelFor(v))}</span>`).join('');
            catsCell.innerHTML = chips || '<span class="hint">없음</span>';
            // 셀렉트 유지(원한다면 초기화 가능)
            msg.textContent = '저장됨'; msg.className='rowmsg ok';
          }catch(e){
            msg.textContent = `오류: ${e.message || String(e)}`; msg.className='rowmsg err';
          }finally{
            btn.disabled = false;
          }
        });
      });
    }

    async function load(){
      status.textContent = '불러오는 중…';
      tbody.innerHTML = `<tr><td colspan="4" class="hint">읽는 중…</td></tr>`;
      try{
        ALL_ROWS = await fetchAllVideos();
        currentPage = 1;
        renderPage();
      }catch(e){
        console.error(e);
        status.textContent = '오류';
        tbody.innerHTML = `<tr><td colspan="4" class="hint err">불러오기 실패: ${escapeHtml(e.message||String(e))}\n광고차단/방화벽/네트워크 상태를 확인해 주세요.</td></tr>`;
      }
    }

    pager.addEventListener('click', (e)=>{
      const b = e.target.closest('.pbtn'); if (!b || b.hasAttribute('disabled')) return;
      const p = parseInt(b.dataset.page, 10);
      if (!isNaN(p)){ currentPage = p; renderPage(); }
    });

    btnReload.addEventListener('click', load);
    load();
  </script>
</body>
</html>
