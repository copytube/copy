<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>카테고리 순서 설정 - CopyTube</title>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    connect-src 'self' https://www.googleapis.com https://firestore.googleapis.com https://securetoken.googleapis.com https://identitytoolkit.googleapis.com https://firebaseinstallations.googleapis.com https://www.gstatic.com https://www.youtube.com;

    img-src 'self' data: https://i.ytimg.com;
    frame-src https://www.youtube.com;
    script-src 'self' https://www.gstatic.com 'unsafe-inline';
    style-src 'self' 'unsafe-inline';
    object-src 'none';
    base-uri 'self';
  ">

  <link rel="stylesheet" href="css/style.css"/>

  <style>
    body{ padding-top:72px; }
    main{ max-width:980px; margin:0 auto; padding:16px; }

    h2{ margin:8px 0 12px; }
    .hint{ color:#9aa0a6; font-size:14px; margin:0 0 12px; }

    /* 3열 레이아웃: 좌/중(아주좁게)/우 */
    .order-grid{
      display:grid;
      grid-template-columns: 1fr minmax(64px, 84px) 1fr; /* 가운데를 최대한 좁게 */
      gap:12px;
      align-items:start;
    }
    .col{
      background:#101010; border:1px solid var(--border); border-radius:10px; padding:10px;
      min-height:320px;
    }
    .col h3{ margin:0 0 8px; font-size:16px; }
    .bucket{
      list-style:none; margin:0; padding:0; display:flex; flex-direction:column; gap:8px;
    }
    .item{
      background:#151515; border:1px solid #2a2a2a; color:#e5e7eb;
      padding:10px 12px; border-radius:8px; cursor:pointer; user-select:none;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      min-height:42px;
    }
    .item .key{ opacity:.6; font-size:12px; }

    /* 가운데 열: 안내 + 버튼 */
    .middle{
      display:flex; flex-direction:column; gap:8px; align-items:stretch; justify-content:flex-start;
      padding:6px; background:#0f0f0f; border:1px solid #2a2a2a; border-radius:10px;
    }
    .arrow-note{
      font-size:12px; color:#bfc6ce; text-align:center; line-height:1.4;
      background:#121212; border:1px dashed #2a2a2a; border-radius:8px; padding:8px;
    }
    .btn-small{
      padding:8px 10px; border-radius:8px; border:1px solid #2a2a2a; background:#111; color:#fff; cursor:pointer;
      font-weight:700;
    }
    .btn-primary{
      background:#4ea1ff; color:#fff; border:0; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:800;
    }

    .actions{
      display:flex; justify-content:flex-end; margin-top:12px;
    }

    @media (max-width:820px){
      .order-grid{ grid-template-columns: 1fr; }
      .middle{ order: -1; } /* 모바일에서 안내가 위로 */
    }
  </style>
</head>
<body>
  <!-- 상단바 -->
  <header id="topbar">
    <div class="brand">
      <a id="brandHome" href="./" aria-label="CopyTube 홈으로">
        <img class="brand-logo" src="image/copytube_logo_side.png" alt="CopyTube"/>
      </a>
    </div>
    <div class="right" style="position:relative;">
      <a id="signupLink" class="link" href="signup.html">Sign up</a>
      <a id="signinLink" class="link" href="signin.html">Sign in</a>
      <span id="welcome" class="welcome"></span>
      <button id="menuBtn" class="icon" aria-label="menu">三</button>
      <div id="dropdownMenu" class="dropdown hidden" role="menu" aria-hidden="true">
        <button id="btnAbout" class="menu-strong" type="button">CopyTube는…</button>
        <button id="btnMyUploads" type="button">내영상관리</button>
        <button id="btnSignOut" type="button">Sign out</button>
        <button id="btnGoUpload" class="menu-strong" type="button">추천영상등록</button>
      </div>
    </div>
  </header>

  <main>
    <h2>카테고리 순서 설정</h2>
    <p class="hint">왼쪽 목록에서 <b>큰 카테고리</b>를 누르면 오른쪽으로 이동합니다. 오른쪽에서 다시 누르면 원래 자리(좌측 기본 위치 기준)로 돌아옵니다.<br/>아래 <b>확인</b>을 누르면 현재 순서가 저장됩니다(로컬 저장).</p>

    <div class="order-grid">
      <!-- 왼쪽 열 -->
      <div class="col">
        <h3>현재 목록</h3>
        <ul id="leftList" class="bucket"></ul>
      </div>

      <!-- 중앙 열 (좁게) -->
      <div class="middle">
        <div class="arrow-note">왼쪽 항목을 누르면<br/>→ 오른쪽으로 이동</div>
        <button id="btnReset" class="btn-small" type="button" title="최근 저장된 순서로 되돌리기">Reset</button>
      </div>

      <!-- 오른쪽 열 -->
      <div class="col">
        <h3>새 순서</h3>
        <ul id="rightList" class="bucket"></ul>
      </div>
    </div>

    <div class="actions">
      <button id="btnConfirm" class="btn-primary" type="button">확인</button>
    </div>
  </main>

  <script type="module">
    import { auth } from './js/firebase-init.js';
    import { onAuthStateChanged, signOut as fbSignOut } from './js/auth.js';
    import { CATEGORY_GROUPS } from './js/categories.js';

    /* ---------- 상단바 ---------- */
    const signupLink   = document.getElementById("signupLink");
    const signinLink   = document.getElementById("signinLink");
    const welcome      = document.getElementById("welcome");
    const menuBtn      = document.getElementById("menuBtn");
    const dropdown     = document.getElementById("dropdownMenu");
    const btnSignOut   = document.getElementById("btnSignOut");
    const btnGoUpload  = document.getElementById("btnGoUpload");
    const btnMyUploads = document.getElementById("btnMyUploads");
    const btnAbout     = document.getElementById("btnAbout");

    let isMenuOpen = false;
    function openDropdown(){ isMenuOpen = true; dropdown.classList.remove("hidden"); requestAnimationFrame(()=> dropdown.classList.add("show")); }
    function closeDropdown(){ isMenuOpen = false; dropdown.classList.remove("show"); setTimeout(()=> dropdown.classList.add("hidden"), 180); }
    onAuthStateChanged(auth, (user)=>{
      const loggedIn = !!user;
      signupLink?.classList.toggle("hidden", loggedIn);
      signinLink?.classList.toggle("hidden", loggedIn);
      menuBtn?.classList.toggle("hidden", !loggedIn);
      welcome && (welcome.textContent = loggedIn ? `안녕하세요, ${user.displayName || '회원'}님` : "");
      closeDropdown();
    });
    menuBtn?.addEventListener("click",(e)=>{ e.stopPropagation(); dropdown.classList.contains("hidden") ? openDropdown() : closeDropdown(); });
    document.addEventListener('pointerdown',(e)=>{ if (dropdown.classList.contains('hidden')) return; if (!e.target.closest('#dropdownMenu, #menuBtn')) closeDropdown(); }, true);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') closeDropdown(); });
    dropdown?.addEventListener("click",(e)=> e.stopPropagation());
    btnGoUpload ?.addEventListener("click", ()=>{ location.href = "upload.html"; closeDropdown(); });
    btnMyUploads?.addEventListener("click", ()=>{ location.href = "manage-uploads.html"; closeDropdown(); });
    btnAbout    ?.addEventListener("click", ()=>{ location.href = "about.html"; closeDropdown(); });
    btnSignOut  ?.addEventListener("click", async ()=>{ await fbSignOut(auth); closeDropdown(); });

    /* ---------- 순서 편집 ---------- */
    const GROUP_ORDER_KEY = 'groupOrderV1';

    const leftList  = document.getElementById('leftList');
    const rightList = document.getElementById('rightList');
    const btnReset  = document.getElementById('btnReset');
    const btnConfirm= document.getElementById('btnConfirm');

    const defaultOrder = CATEGORY_GROUPS.map(g => g.key); // 기본 순서
    const defaultIndex = new Map(defaultOrder.map((k,i)=>[k,i]));

    function getSavedOrder(){
      try{
        const arr = JSON.parse(localStorage.getItem(GROUP_ORDER_KEY) || 'null');
        return Array.isArray(arr) && arr.length ? arr : null;
      }catch{ return null; }
    }
    function saveOrder(arr){
      localStorage.setItem(GROUP_ORDER_KEY, JSON.stringify(arr));
    }

    function renderInitial(){
      // 최근 저장된 순서가 있으면 그것을 좌측에 전부 배치
      const saved = getSavedOrder();
      const useOrder = saved && saved.length ? saved : defaultOrder.slice();

      leftList.innerHTML = '';
      rightList.innerHTML = '';

      for (const key of useOrder){
        const g = CATEGORY_GROUPS.find(x => x.key === key);
        if (!g) continue;
        leftList.appendChild(makeItem(key, g.label));
      }
    }

    function makeItem(key, label){
      const li = document.createElement('li');
      li.className = 'item';
      li.dataset.key = key;
      const title = document.createElement('span');
      title.textContent = label;
      const sub = document.createElement('span');
      sub.className = 'key';
      sub.textContent = key;
      li.appendChild(title);
      li.appendChild(sub);
      li.addEventListener('click', onItemClick);
      return li;
    }

    function onItemClick(e){
      const li  = e.currentTarget;
      const src = li.parentElement;

      if (src === leftList){
        // 좌 → 우 (맨 아래로)
        rightList.appendChild(li);
      }else{
        // 우 → 좌 (기본 순서 기준의 원래 자리로 되돌리기)
        const key = li.dataset.key;
        const targetIndex = defaultIndex.get(key) ?? Number.MAX_SAFE_INTEGER;

        const siblings = Array.from(leftList.children);
        let insPos = siblings.length;
        for (let i=0;i<siblings.length;i++){
          const k2 = siblings[i].dataset.key;
          const idx2 = defaultIndex.get(k2) ?? Number.MAX_SAFE_INTEGER;
          if (idx2 > targetIndex){ insPos = i; break; }
        }
        if (insPos >= siblings.length){ leftList.appendChild(li); }
        else{ leftList.insertBefore(li, siblings[insPos]); }
      }
    }

    btnReset.addEventListener('click', ()=>{
      // “최근 저장된 순서”로 전부 좌측에 복원
      renderInitial();
    });

    btnConfirm.addEventListener('click', ()=>{
      // 우측(새 순서) + 좌측(남은 것들: 현재 순서) 이어 붙여 저장
      const rightKeys = Array.from(rightList.children).map(li=>li.dataset.key);
      const leftKeys  = Array.from(leftList.children).map(li=>li.dataset.key);
      const newOrder  = rightKeys.concat(leftKeys);
      saveOrder(newOrder);
      // 저장 후 index로 이동
      location.href = 'index.html';
    });

    renderInitial();
  </script>
</body>
</html>
